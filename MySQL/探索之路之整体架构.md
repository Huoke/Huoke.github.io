<h1 align=center> MySQL探索之路整体架构 </h1>


<h2 align=center> 第一章 </h2>

# 一、MySQL的历史与架构

Monty Widenius 创建Unireg，一种具有报告前端的低层次存储引擎。 与自己的代码厮守多年20年，在TcX公司。

20世纪90年代，TcX的客户强烈的要求为其数据提供SQL接口。Monty Widenius尝试用mSQL的代码的SQL部分整合到他的低层次存储引擎中，效果不好。

于是牛逼的人“我受够了别人写的那些没用的东西！我要自己写”。

96年他发布了MySQL 1.0版本。接着在同年10月发布了3.11.1版。

3.22版，该版本支持一个不错的SQL语言子集，有一个更为复杂的优化器，很快、很稳定。但是它缺少对事物、子查询、外键、存储过程、视图的支持。
只有表锁可供使用，这使得程序执行速度逐渐变慢，直到停止。但是有一帮人在不断的编写代码来克服这些限制，以此来提高性能节省许可费。

99年——2000，MySQL AB公司成立，为Berkeley DB数据文件提供SQL接口。由于Berkeley DB具有事物功能，因此可以为MySQL提供事物支持，这是MySQL
以前没有的特性。几次修改后3.23版本发布。结果MySQL源代码开始有了各种挂钩，可以添加任何类型存储引擎，包括事务存储引擎在内。

2000.3 增加了主从服务器复制功能。重新编写了非事务存储引擎ISAM，以MyISAM为名发行。增加了纯文本搜索的功能。

2001年底Heikki Tuuri联系上了MySQL AB，提议整合他自己的存储引擎InnoDB，这一存储引擎同样具有事物和行层次锁功能，由于MySQL在与Berkeley DB整合的过程中已经理顺了表处理器接口，所以整合相对来说要更快速一些。

2002年 Heikki Tuuri的InnoDB和MySQL组合趋于稳定，2003.3 立刻发布了MySQL4.0稳定版本。4.0版本融合了InnoDB；查询高速缓存，大大改善了大量应用程序的性能。
从服务器上的复制代码经过重新编写可以使用两种线程：一种用于来自主服务器的网络I/O，另一种则用于处理更新(提供热升级)。优化器也做了一些改进。客户端/服务器协议开始具有SSL功能。


2003.4月发布了 MySQL 4.1的alpha版本。6月发布beta版本。4.1改进重大，最重要的是子查询。MyISAM存储引擎中增加了空间索引支持。实现了Unicode支持。
客户端/服务器协议大为改观，这使得它在对抗攻击的安全性更强，并支持预处理语句。


MySQL 4.1的alpha版本发布的同时，成立一支独立的开发队伍开发5.0版本 增加存储过程、服务器端光标、触发器、视图、XA事务、查询优化器重大改进以及其他特性。
这样操作是因为MySQL开发者认为，除了正在增加的所有新功能，如果首先要处理存储过程，那么要得到稳定的4.1版本需要很长的时间。5.0 alpha版本于2003.12发布。
这一时之间造成了一点混乱，因为有两个分支都处于alpha阶段。最后4.1版本终于稳定(2004.10); 5.0版本则在一年以后变得稳定(2005.10)。

2005.11 5.1版本的第一个alpha版本，该版本进行了大量改进，其中包括表数据区分、基于行的复制、事件调度器和有利于新存储引擎及其他插件集成的标准插件API。

# 二、MySQL 的架构
MySQL 架构的大部分都没有正式的定义或规范。大部分代码在最初编写的时候都不是为了将来能成为大型系统的组成部分，而是为了解决某些特定的问题。

不过，由于编写出色，思虑周详，以至于有足够多的合格板块，能够方便地组成数据库服务器。

## 2.1、核心模块
MySQL开发人员更倾向于考虑文件、目录、类结构和函数。他们对代码了解的很透彻，能从函数、结构和类的层面进行概念化思维，但是习惯于模块和管理器方式思考的人来说，进行规范化是所有帮助的。比如： “者出现在mi_open()中”之类的说法，在模块化后表达方式就是“出现在MyISAM存储引擎层中”。

早期来自一个模块的代码可能分布在几个文件中，新的代码更符合模块形式，因此这里定义模块时逻辑上某种方式结合在一起的一段代码，并且能在服务器中完成某种重要功能。

可在服务器中识别出下列模块：
- 服务器初始化模块
- 连接管理器
- 线程管理器
- 连接线程
- 用户验证模块
- 访问控制模块
- 解析器
- 命令调度器
- 查询高速缓存模块
- 优化器
- 表管理器
- 表修改模块
- 表维护模块
- 状态报告模块
- 抽象存储引擎接口(表处理器)
- 存储引擎实现(MyISAM、InnoDB、MEMORY、BerkeleyDB)
- 日志记录模块
- 主复制服务器模块
- 从复制服务器模块
- 客户端/服务器协议API
- 底层网络I/O API
- 核心API



## 2.2、核心模块间交互


MySQL 服务器术语中有两种类型的客户端请求：查询和命令。
   - 查询(query)：是任何必须经过解析器的请求，包括DELETE或INSERT。
   - 命令(command)：不需要调用解析器即可执行的请求。

启用全查询日志记录，命令调度器将在调度前要求日志记录模块将查询或命令记录在纯文本日志中。因此，在全日志记录配置中，所有的查询都将被记录，即使这条语句存在语法错误，不会执行并立即返回一个错误的查询也会被记录到日志中。

命令调度器通过查询高速缓存模块将查询发送给解析器。
查询告诉缓存模块检查查询是否是可高速缓存的类型，同时检查是否存在一个任然有效的、以前计算得出的高速缓存结果。
- 如果找到则直接返回结果给用户，然后连接线程接手控制权，这时处理另外一个命令。
- 如果查询高速缓存模块中没有目标，则查询发送给解析器，由解析器根据查询类型决定如何传送控制权。




## 2.3、细看核心模块
将早期使用的概念性语言与实际源码结合起来。

### 2.3.1、服务器初始化模块
main()，在sql/mysqld.cc中，负责启动时完成服务器初始化。
- init_common_variables()
- init_thread_environment()
- init_server_components()
- sql/sql_acl.cc中grant_init()
- sql/slave.cc中的init_slave()
- get_option()

3.22版本代码没有被彻底重写，但是MySQL增加新功能时被大量重构，过去属于main()的初始化代码经过重新组织，逐渐分为各种辅助函数。
4.0版本MySQL核心API出现选项解析器后，命令行和配置文件选项解析从GNU 的getopt()切换到MySQL的核心API选项解析器中。
5.1版本为init_server_components（）增加了一个重要部分，进行插件初始化。

总体看初始化模块代码相当稳定。
### 2.3.2、连接管理器
监听来自客户的连接，然后派发给线程管理器。
就是一个函数，handle_connections_sockets()。由于作用重要，所以单独独立为一个模块，这里会因为跨平台所以会有大量的#ifdef指令。
### 2.3.3、线程管理器


## 2.4、低层次 网络I/O API






